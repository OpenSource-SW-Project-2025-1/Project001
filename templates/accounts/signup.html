{% extends 'base.html' %}
{% load static %}
{% block content %}
    {% include 'accounts/menu.html' %}

    {% if error %}
        <p style="color: red;">{{ error }}</p>
    {% endif %}

    <main class="main">
        <h2 class="login-title">회원가입</h2>


        <!-- 주의사항 html -->
        <div class="form-guidelines">
            <p><strong style="color:red">* </strong>표시는 필수 입력 항목입니다.</p>
            <p>비밀번호와 아이디는 영문자, 숫자만 이용해 입력해 주세요.</p>
        </div>

        <!-- 회원가입 form -->
        <form method="POST" class="signup-form">
             {% csrf_token %}

            <!-- 아이디 / 비밀번호 박스 -->
            <div class="form-box">
                <!-- 아이디 입력 html -->
                <div class="input-group">
                    <label for="user_id">
                        아이디 <span class="required">*</span> <small>영문( 소문자 )와 숫자를 조합해 3~5자</small>
                    </label>
                    <div class="inline-group">
                        <input type="text" id="user_id" name='user_id' placeholder="아이디 입력" required>

                        <button class="check-btn" type="button" onclick="checkDuplicate()">중복 확인</button>
                    </div>
                </div>

                <!-- 비밀번호 입력 -->
                <div class="input-group">
                    <label for="user_pw">비밀번호 <span class="required">*</span></label>
                    <input type="password" id="user_pw" name="user_pw" placeholder="9~24자, 대/소문자, 숫자 포함" required>
                    <small id="pw-error" style="color: red; display: none;"></small>
                </div>

                <!-- 비밀번호 확인 -->
                <div class="input-group">
                    <label for="confirm_pw">비밀번호 확인 <span class="required">*</span></label>
                    <input type="password" id="confirm_pw" placeholder="비밀번호 다시 입력" required>
                    <small id="confirm-error" style="color: red; display: none;"></small>
                    <small id="pw-success" style="color: green; display: none;"></small>
                </div>

                <!-- 이메일 입력 html -->
                <div class="input-group">
                    <label for="user_email">사용자 이메일 <span class="required">*</span></label>
                    <input type="email" name='user_email' id='user_email' placeholder="이메일 입력" required>
                </div>

                <!-- 사용자 번호 html -->
                <div class="input-group">
                    <label for="user_phone_no">사용자 번호 <span class="required">*</span></label>
                    <input type="text" name='user_phone_no' id='user_phone_no' placeholder="숫자만 입력" oninput="checkInteger(this)" required>
                </div>
            </div>


            <!-- 거주 정보 박스 -->
            <div class="form-box">

            <!-- 거주지역 html -->
            <div class="input-group">
              <label for="location">거주지역 <span class="required">*</span></label>
              <select name="location" id="location" required>
                <option value="">지역을 선택하세요</option>
                {% for loc in locations %}
                  <option value="{{ loc.id }}">{{ loc.sido }} {{ loc.sigungu }}</option>
                {% endfor %}
              </select>
            </div>

                <!-- 생년월일 html -->
                <div class="input-group">
                    <label for="user_birthdate">생년월일 <span class="required">*</span></label>
                    <input type="date" name='user_birthdate' id='user_birthdate' required>
                </div>

                <!-- 혼인여부/형제자매 수 html -->
                <div class="inline-pair">
                    <div class="input-group">
                        <label for="merry">혼인 여부</label>
                        <input type="text" id='merry'placeholder="기혼/미혼">
                    </div>
                    <div class="input-group">
                        <label for='bro'>형제자매 수</label>
                        <div class="with-unit">
                            <input type="number" id="bro" min="0">
                            <span>명</span>
                        </div>
                    </div>
                </div>

                <!-- 취업상태 html -->
                <div class="input-group">
                    <label for="user_job">취업 상태</label>
                    <input type="text" name='user_job' id='user_job' placeholder="예: 미취업, 재직 중">
                </div>

                <!-- 소속 html -->
                <div class="input-group">
                    <label for="user_classification">소속</label>
                    <input type="text" name='user_classification' id='user_classification' placeholder="학교, 회사 등">
                </div>

                <!-- 연 평균 소득 html -->
                <div class="input-group">
                    <label for="user_income">연 평균 소득 (단위 : 만 원)</label>
                    <div class="with-unit">
                        <input type="text" name='user_income' min='0' max='10000000' id='user_income' oninput="checkInteger(this)">
                    </div>
                </div>

                <div class="input-group checkbox-group">
                    <label class="agreement-label" for="agree">
                        개인정보 이용에 동의합니다 <span class="required">*</span>
                        <input type="checkbox" id="agree" required style="margin-left: 8px;" />
                    </label>
                    <a href="#" class="agreement-btn">개인정보 이용 동의서 보기</a>
                </div>



                <!-- 회원가입 버튼 -->
                <div class="submit-area">
                    <button type="submit" class="signup-btn" id="submit-btn" >회원가입</button>
                </div>



                <script>
                    function checkInteger(elem) {
                        const value = elem.value;
                        if (!/^[-]?\d*$/.test(value)) {
                            elem.value = value.slice(0, -1); // 마지막 문자를 제거
                        }
                    }
                      const submitBtn = document.getElementById('submit-btn');

                    function updateSubmitButton() {
                        const allValid = Object.values(validation).every(Boolean);
                        submitBtn.disabled = !allValid;
                    }

                    function checkDuplicate() {
                        const user_id = document.getElementById('user_id').value;

                        if (!/^[a-z0-9]{3,5}$/.test(user_id)) {
                            alert("아이디는 소문자+숫자 조합 3~5자여야 합니다.");
                            return;
                        }

                        fetch(`/accounts/check_id/?user=${user_id}`)
                            .then(response => response.json())
                            .then(data => {

                                if (data.exists) {
                                    alert("이미 존재하는 아이디입니다.");
                                } else {
                                    alert("사용 가능한 아이디입니다.");
                                    validation.id = true; updateSubmitButton();
                                }
                            });
                    }

                    // 비밀번호 확인 script
                    function validatePassword() {
                        const pw = document.getElementById('user_pw').value;
                        const confirm = document.getElementById('confirm_pw').value;

                        const pwError = document.getElementById('pw-error');
                        const confirmError = document.getElementById('confirm-error');
                        const pwSuccess = document.getElementById('pw-success');

                        const pwRule = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[A-Za-z\d]{9,24}$/;

                        // 메시지 초기화
                        pwError.style.display = 'none';
                        confirmError.style.display = 'none';
                        pwSuccess.style.display = 'none';
                        pwError.textContent = '';
                        confirmError.textContent = '';
                        pwSuccess.textContent = '';

                        // 1. 비밀번호 형식 체크
                        if (!pwRule.test(pw)) {
                            pwError.textContent = '비밀번호는 9~24자, 대/소문자 및 숫자를 포함해야 합니다.';
                            pwError.style.display = 'block';
                            return;
                        }

                        // 2. 비밀번호 확인이 비어있지 않으면 일치 여부 검사
                        if (confirm !== '') {
                            if (pw !== confirm) {
                                confirmError.textContent = '비밀번호가 일치하지 않습니다.';
                                confirmError.style.display = 'block';
                                return;
                            }
                        }

                        // 3. 모두 통과한 경우 성공 메시지
                        if (pw === confirm && confirm !== '') {
                            pwSuccess.textContent = '사용 가능한 비밀번호입니다.';
                            pwSuccess.style.display = 'block';
                            validation.pw = true; updateSubmitButton();
                        }
                    }

                    // 이벤트 연결
                    document.getElementById('user_pw').addEventListener('input', validatePassword);
                    document.getElementById('confirm_pw').addEventListener('input', validatePassword);

                </script>
            </div>
        </form>
    </main>
{% endblock %}
