{% extends 'base.html' %}
{% load static %}
{% block content %}
    {# ì±—ë´‡ í˜ì´ì§€ì—ì„œëŠ” ìƒë‹¨ ë©”ë‰´ë°”ê°€ í•„ìš” ì—†ë‹¤ê³  íŒë‹¨ë˜ë©´ ì´ ì¤„ì„ ì œê±°í•˜ì„¸ìš” #}
    {% include 'accounts/menu.html' %}

    <main class="main">

    <section class="chatbot-chat-area" id="chatAreaAI">
        <div class="chatbot-message-wrapper chatbot-message-bot">
            <span class="chatbot-emoji">ğŸ“</span>
            <div class="chatbot-bubble">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
        </div>
    </section>

    <div class="chatbot-input-area" id="inputAreaAI">
        <form class="chatbot-input-form">
            <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            <button type="submit">ì „ì†¡</button>
        </form>
    </div>
</main>
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector(".chatbot-input-form");
  const input = form.querySelector("input");
  const sendButton = form.querySelector('button[type="submit"]');
  const chatArea = document.querySelector(".chatbot-chat-area");

  let chatHistory = [];

  const API_TIMEOUT_MS = 10000;

  function setInputEnabled(enabled) {
    input.disabled = !enabled;
    sendButton.disabled = !enabled;
    if (enabled) input.focus();
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userMessage = input.value.trim();
    if (!userMessage) return;

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥
    const userMsg = document.createElement("div");
    userMsg.className = "chatbot-message-wrapper chatbot-message-user";
    userMsg.innerHTML = `<div class="chatbot-bubble">${userMessage}</div>`;
    chatArea.appendChild(userMsg);
    input.value = "";
    chatArea.scrollTop = chatArea.scrollHeight;

    chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
    setInputEnabled(false);

    // ë¡œë”© ë©”ì‹œì§€
    const loadingMsg = document.createElement("div");
    const loadingId = `loading-${Date.now()}`;
    loadingMsg.className = "chatbot-message-wrapper chatbot-message-bot";
    loadingMsg.id = loadingId;
    loadingMsg.innerHTML = `
      <span class="chatbot-emoji">ğŸ“</span>
      <div class="chatbot-bubble">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
      </div>
    `;
    chatArea.appendChild(loadingMsg);
    chatArea.scrollTop = chatArea.scrollHeight;

    let botReply = "ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ì„ ë°›ì•„ì˜¤ëŠ”ë° ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤.";

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), API_TIMEOUT_MS);

    try {
      const res = await fetch("/chatbot/reply/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          message: userMessage,
          history: chatHistory,
        }),
        signal: controller.signal,
      });

      clearTimeout(timeout);

      if (!res.ok) {
        const errData = await res.json();
        botReply = `ì˜¤ë¥˜: ${errData.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜"}`;
      } else {
        const data = await res.json();
        botReply = data.reply;
      }
    } catch (error) {
      clearTimeout(timeout);
      botReply = error.name === "AbortError"
        ? "ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."
        : "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    } finally {
      const loadingEl = document.getElementById(loadingId);
      let processed = botReply.replace(/\n/g, "<br>");
      const urlRegex = /(https?:\/\/[^\s<>"'()]+)/g;
      processed = processed.replace(urlRegex, '<a href="$&" target="_blank" rel="noopener noreferrer">$&</a>');

      if (loadingEl) {
        loadingEl.querySelector(".chatbot-bubble").innerHTML = processed;
      }

      if (!botReply.startsWith("ì£„ì†¡í•©ë‹ˆë‹¤") &&
          !botReply.startsWith("ì˜¤ë¥˜:") &&
          !botReply.startsWith("ë„¤íŠ¸ì›Œí¬")) {
        chatHistory.push({ role: "model", parts: [{ text: botReply }] });
      }

      chatArea.scrollTop = chatArea.scrollHeight;
      setInputEnabled(true);
    }
  });

  function getCookie(name) {
    const cookies = document.cookie.split(';');
    for (let c of cookies) {
      const trimmed = c.trim();
      if (trimmed.startsWith(name + "=")) {
        return decodeURIComponent(trimmed.substring(name.length + 1));
      }
    }
    return null;
  }

  function adjustChatAreaHeight() {
    const headerH = document.querySelector("header")?.offsetHeight || 0;
    const footerH = document.querySelector("footer")?.offsetHeight || 0;
    const inputH = document.getElementById("inputAreaAI")?.offsetHeight || 0;
    const chatArea = document.getElementById("chatAreaAI");
    if (chatArea) {
      const newHeight = window.innerHeight - headerH - footerH - inputH - 24;
      chatArea.style.maxHeight = `${newHeight}px`;
    }
  }

  adjustChatAreaHeight();
  window.addEventListener("resize", adjustChatAreaHeight);
});
</script>

{% endblock %}